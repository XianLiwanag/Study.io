<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study.io | Student Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        oxfordRed: '#b91c1c', 
                        oxfordDark: '#7f1d1d' 
                    },
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'] 
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800" x-data="studentApp()">

    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 sm:h-20 items-center">
            
            <div class="flex items-center gap-2 sm:gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="bg-oxfordRed text-white p-1.5 sm:p-2 rounded-lg">
                    <i class="fa-solid fa-user-graduate text-xl sm:text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg sm:text-2xl font-bold text-oxfordRed leading-tight">Study.io</h1>
                    <p class="text-[9px] sm:text-xs text-gray-500 uppercase tracking-widest leading-tight">Student Portal</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                
                <a href="index.html" class="text-sm text-gray-600 hover:text-oxfordRed transition font-medium flex items-center gap-1.5 p-2 sm:p-0">
                    <i class="fa-solid fa-house text-lg sm:text-sm"></i> 
                    <span class="hidden sm:inline">Home</span>
                </a>
                
                <div class="h-6 sm:h-8 w-px bg-gray-300 mx-1 sm:mx-2 hidden sm:block"></div>
                
                <div class="flex items-center gap-2 text-gray-700 bg-gray-100 px-2 sm:px-3 py-1 sm:py-1.5 rounded-full border border-gray-200 ml-1 sm:ml-2">
                    <img :src="finalAvatarUrl" class="w-6 h-6 sm:w-7 sm:h-7 rounded-full border border-gray-300 object-cover bg-white">
                    <span class="font-semibold text-xs sm:text-sm hidden sm:inline truncate max-w-[100px]" x-text="profile.name"></span>
                </div>

                <button @click="logout()" class="text-sm text-red-600 sm:text-gray-500 hover:text-white sm:hover:text-oxfordRed hover:bg-red-600 sm:hover:bg-red-50 transition font-medium ml-1 sm:ml-2 sm:border border-gray-300 px-2 sm:px-3 py-1.5 rounded-md shadow-sm flex items-center gap-1.5">
                    <i class="fa-solid fa-arrow-right-from-bracket text-lg sm:text-sm"></i> 
                    <span class="hidden sm:inline">Log Out</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="bg-white border-b border-gray-200 sticky top-16 sm:top-20 z-30">
        <div class="max-w-7xl mx-auto px-4 flex gap-6">
            <button @click="activeTab = 'profile'" :class="activeTab === 'profile' ? 'border-oxfordRed text-oxfordRed' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="py-4 font-bold text-sm sm:text-base border-b-2 transition flex items-center gap-2">
                <i class="fa-solid fa-user-pen"></i> My Profile
            </button>
            <button @click="activeTab = 'inbox'" :class="activeTab === 'inbox' ? 'border-oxfordRed text-oxfordRed' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="py-4 font-bold text-sm sm:text-base border-b-2 transition flex items-center gap-2 relative">
                <i class="fa-solid fa-inbox"></i> Tutor Inbox
                <span x-show="contacts.length > 0" class="absolute top-3 -right-3 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>
            </button>
        </div>
    </div>

    <main x-show="activeTab === 'profile'" class="max-w-7xl mx-auto px-4 py-8 sm:py-12 grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8 min-h-[70vh]">
        
        <div class="lg:col-span-1">
            <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fa-regular fa-address-card text-oxfordRed"></i> My Student Card
            </h3>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 lg:sticky lg:top-40">
                
                <div :class="profile.coverImageUrl ? '' : profile.headerColor" 
                     :style="profile.coverImageUrl ? `background-image: url('${profile.coverImageUrl}'); background-size: cover; background-position: center;` : ''" 
                     class="h-24 sm:h-32 relative transition-all duration-300">
                </div>
                
                <div class="px-5 sm:px-6 pb-5 sm:pb-6 relative">
                    <div class="flex justify-between items-end -mt-10 sm:-mt-12 mb-4">
                        <img :src="finalAvatarUrl" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-white shadow-md bg-white object-cover">
                    </div>
                    
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 leading-tight" x-text="profile.name || 'Student Name'"></h2>
                    
                    <div class="flex flex-wrap items-center text-gray-500 text-[10px] sm:text-xs mt-1.5 sm:mt-2 mb-4 gap-2">
                        <span class="font-medium text-gray-700 bg-gray-100 px-2.5 py-1 rounded-full border border-gray-200">
                            <i class="fa-solid fa-school text-oxfordRed mr-1"></i> <span x-text="profile.strand || 'Not Specified'"></span>
                        </span>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 border-b border-gray-200 pb-1 mb-2 text-xs sm:text-sm">About Me</h3>
                    <p class="text-gray-600 text-xs sm:text-sm leading-relaxed mb-4 whitespace-pre-wrap" x-text="profile.bio || 'Write a little about yourself...'"></p>
                    
                    <div class="bg-red-50 p-3 sm:p-4 rounded-xl border border-red-100 shadow-sm mt-5 sm:mt-6">
                        <h3 class="font-bold text-oxfordRed mb-2 sm:mb-3 text-xs sm:text-sm flex items-center gap-1.5 sm:gap-2">
                            <i class="fa-solid fa-book-open"></i> Subjects I Need Help With
                        </h3>
                        <div class="flex flex-wrap gap-1.5 sm:gap-2">
                            <template x-for="sub in profile.subjects">
                                <span class="text-[10px] sm:text-xs bg-white text-gray-700 px-2.5 py-1 rounded-full border border-gray-200 shadow-sm">
                                    <span x-text="sub"></span>
                                </span>
                            </template>
                            <span x-show="profile.subjects.length === 0" class="text-xs text-gray-400 italic">No subjects added yet.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white p-5 sm:p-8 rounded-xl shadow-sm border border-gray-200">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-5 sm:mb-6 border-b border-gray-100 pb-4 gap-2">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Edit Profile Settings</h2>
                        <p class="text-xs sm:text-sm text-gray-500">Personalize your account. Tutors will see this when you message them!</p>
                    </div>
                    <div class="text-[10px] sm:text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 self-start sm:self-auto inline-flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Auto-Saving
                    </div>
                </div>
                
                <div class="space-y-5 sm:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Full Name</label>
                            <input type="text" x-model="profile.name" @input="saveProfile()" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Grade & Strand</label>
                            <input type="text" x-model="profile.strand" @input="saveProfile()" placeholder="e.g. Grade 11 - STEM" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Default Theme Color</label>
                            <select x-model="profile.headerColor" @change="saveProfile()" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm bg-white text-sm">
                                <option value="bg-gray-800">Slate Dark (Default)</option>
                                <option value="bg-oxfordRed">Oxford Red</option>
                                <option value="bg-blue-600">Ocean Blue</option>
                                <option value="bg-green-600">Forest Green</option>
                                <option value="bg-purple-600">Royal Purple</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 sm:p-5 rounded-xl border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Profile Picture (URL)</label>
                                <input type="text" x-model="profile.avatarUrl" @input="saveProfile()" placeholder="Paste image link here..." class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none text-xs sm:text-sm transition shadow-sm">
                                
                                <div class="mt-3">
                                    <p class="text-[10px] font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Quick Select Avatars</p>
                                    <div class="flex gap-2">
                                        <template x-for="img in defaultAvatars">
                                            <img :src="img" @click="profile.avatarUrl = img; saveProfile()" class="w-8 h-8 rounded-full cursor-pointer hover:ring-2 hover:ring-oxfordRed border border-gray-300 object-cover bg-white transition-transform hover:scale-110">
                                        </template>
                                        <button @click="profile.avatarUrl = ''; saveProfile()" class="w-8 h-8 rounded-full cursor-pointer border border-gray-300 bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors" title="Clear Avatar"><i class="fa-solid fa-eraser text-xs text-gray-500"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Cover Photo (URL)</label>
                                <input type="text" x-model="profile.coverImageUrl" @input="saveProfile()" placeholder="Paste image link here..." class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none text-xs sm:text-sm transition shadow-sm">
                                
                                <div class="mt-3">
                                    <p class="text-[10px] font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Quick Select Covers</p>
                                    <div class="flex gap-2">
                                        <template x-for="img in defaultCovers">
                                            <div @click="profile.coverImageUrl = img; saveProfile()" class="w-12 h-8 rounded cursor-pointer hover:ring-2 hover:ring-oxfordRed border border-gray-300 bg-cover bg-center transition-transform hover:scale-105" :style="`background-image: url('${img}')`"></div>
                                        </template>
                                        <button @click="profile.coverImageUrl = ''; saveProfile()" class="w-12 h-8 rounded cursor-pointer border border-gray-300 bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors" title="Clear Cover"><i class="fa-solid fa-eraser text-xs text-gray-500"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Short Bio</label>
                        <textarea x-model="profile.bio" @input="saveProfile()" placeholder="Tell tutors a bit about your learning style..." rows="3" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm"></textarea>
                    </div>

                    <div class="border-t border-gray-200 pt-5 sm:pt-6">
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">Subjects I Need Help With</label>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4">
                            <select x-model="selectedSubjectToAdd" class="flex-1 border border-gray-300 rounded-md py-2.5 px-3 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm bg-white text-sm">
                                <option value="">-- Select a subject to add --</option>
                                <template x-for="(subjects, category) in groupedSubjects" :key="category">
                                    <optgroup :label="category">
                                        <template x-for="sub in subjects" :key="sub">
                                            <option :value="sub" x-text="sub"></option>
                                        </template>
                                    </optgroup>
                                </template>
                            </select>
                            <button @click="addSubject()" class="bg-gray-800 text-white px-6 sm:px-8 py-2.5 rounded-md font-bold hover:bg-black transition shadow-md text-sm sm:text-base w-full sm:w-auto">Add Subject</button>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(sub, index) in profile.subjects" :key="index">
                                <div class="bg-gray-50 border border-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-xs sm:text-sm flex items-center gap-2 sm:gap-3 shadow-sm">
                                    <span x-text="sub" class="font-medium"></span>
                                    <button @click="removeSubject(index)" class="text-red-400 hover:text-red-600 transition p-1">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main x-cloak x-show="activeTab === 'inbox'" class="max-w-7xl mx-auto px-4 py-8 sm:py-12 min-h-[70vh]">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col md:flex-row h-[700px] max-h-[80vh]">
            
            <div class="w-full md:w-1/3 border-r border-gray-200 flex flex-col bg-gray-50 flex-shrink-0 h-1/3 md:h-full">
                <div class="p-4 border-b border-gray-200 bg-white shadow-sm z-10 flex-shrink-0">
                    <h3 class="font-bold text-gray-800 text-lg">My Tutors</h3>
                </div>
                <div class="overflow-y-auto flex-1 chat-scroll p-2 space-y-1">
                    <template x-for="contact in contacts" :key="contact.id">
                        <button @click="selectContact(contact)" :class="activeContact?.id === contact.id ? 'bg-oxfordRed text-white shadow-md' : 'bg-transparent text-gray-800 hover:bg-gray-200'" class="w-full text-left p-3 rounded-lg transition flex items-center gap-3">
                            <img :src="contact.avatarUrl" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover bg-white">
                            <div class="overflow-hidden flex-1">
                                <div class="font-bold text-sm truncate" x-text="contact.name"></div>
                                <div :class="activeContact?.id === contact.id ? 'text-red-100' : 'text-gray-500'" class="text-xs truncate" x-text="contact.strand"></div>
                            </div>
                        </button>
                    </template>
                    <div x-show="contacts.length === 0" class="text-center p-6 text-gray-400 text-sm">
                        <i class="fa-solid fa-inbox text-3xl mb-2 text-gray-300"></i><br>No messages yet.
                    </div>
                </div>
            </div>

            <div class="w-full md:w-2/3 flex flex-col h-2/3 md:h-full bg-white relative">
                
                <div x-show="!activeContact" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-10 bg-white">
                    <i class="fa-regular fa-comments text-6xl mb-4 text-gray-200"></i>
                    <p class="text-lg font-medium text-gray-500">Select a tutor to start chatting</p>
                </div>

                <template x-if="activeContact">
                    <div class="flex flex-col h-full w-full">
                        <div class="bg-white border-b border-gray-200 p-4 shadow-sm flex-shrink-0">
                            <div class="flex items-start gap-4">
                                <img :src="activeContact.avatarUrl" class="w-14 h-14 rounded-full border border-gray-200 object-cover shadow-sm bg-white">
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h2 class="text-lg font-bold text-gray-800 truncate" x-text="activeContact.name"></h2>
                                        
                                        <div class="text-right flex-shrink-0 ml-2">
                                            <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Rate</span><br>
                                            <span class="text-sm font-bold text-green-600 border border-green-200 bg-green-50 px-2 py-0.5 rounded shadow-sm whitespace-nowrap">â‚±<span x-text="activeContact.hourlyRate || '0'"></span>/hr</span>
                                        </div>
                                    </div>
                                    <p class="text-xs font-semibold text-oxfordRed mb-1" x-text="activeContact.strand"></p>
                                    <p class="text-xs text-gray-600 line-clamp-2 italic pr-4">"<span x-text="activeContact.bio || 'Professional Tutor'"></span>"</p>
                                </div>
                            </div>
                            <div class="mt-3 flex flex-wrap gap-1.5" x-show="activeContact.subjects && activeContact.subjects.length > 0">
                                <template x-for="sub in activeContact.subjects">
                                    <span class="text-[10px] bg-gray-100 text-gray-700 border border-gray-200 px-2 py-0.5 rounded-full shadow-sm" x-text="sub"></span>
                                </template>
                            </div>
                        </div>

                        <div id="inbox-messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-4 chat-scroll">
                            <template x-for="(msg, index) in activeChatHistory" :key="index">
                                <div class="w-full flex flex-col">
                                    
                                    <div x-show="msg.senderId === mySessionId" class="self-end flex flex-col w-full max-w-[85%] items-end">
                                        <div class="flex gap-2 w-full justify-end">
                                            <div class="bg-oxfordRed text-white p-3 rounded-2xl rounded-tr-none text-sm shadow-sm leading-relaxed" x-text="msg.text"></div>
                                        </div>
                                    </div>
                                    
                                    <div x-show="msg.senderId !== mySessionId" class="self-start flex flex-col w-full max-w-[85%]">
                                        <div class="flex gap-2 w-full">
                                            <img :src="msg.avatarUrl" class="w-8 h-8 rounded-full border border-gray-200 object-cover shadow-sm bg-white flex-shrink-0">
                                            <div class="bg-white border border-gray-200 text-gray-800 p-3 rounded-2xl rounded-tl-none text-sm shadow-sm leading-relaxed" x-text="msg.text"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="p-3 border-t border-gray-200 bg-white flex gap-2 flex-shrink-0">
                            <input type="text" x-model="inboxMessage" @keydown.enter="sendInboxMessage()" placeholder="Message your tutor..." class="flex-1 text-sm border border-gray-300 rounded-full px-5 py-2.5 focus:outline-none focus:ring-2 focus:ring-oxfordRed focus:border-oxfordRed transition shadow-inner">
                            <button @click="sendInboxMessage()" class="bg-oxfordRed text-white w-11 h-11 rounded-full flex justify-center items-center hover:bg-oxfordDark transition shadow-md flex-shrink-0">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <script>
        // Supabase initialized with SessionStorage for Tab Isolation
        const supabaseClient = window.supabase.createClient(
            'https://vdtokaamdrvyzchtepjy.supabase.co', 
            'sb_publishable_1HRmAvVpSXBSpzjOeE5ZeA_Atr3x015',
            { auth: { storage: window.sessionStorage } }
        );

        function studentApp() {
            return {
                currentUser: null,
                activeTab: 'profile', // Default to Profile View
                profile: {
                    name: "Demo Student", 
                    strand: "Grade 11", 
                    bio: "I am a visual learner looking for help with my core subjects.",
                    headerColor: "bg-gray-800",
                    avatarUrl: "", 
                    coverImageUrl: "",
                    subjects: []
                },
                
                selectedSubjectToAdd: "", 

                // INBOX VARIABLES
                contacts: [],
                activeContact: null,
                allMessages: [],
                inboxMessage: '',
                mqttClient: null,
                mySessionId: 'student_' + Math.random().toString(36).substr(2, 9),
                
                // NEW DEFAULT PRE-MADES
                defaultAvatars: [
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Nala',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Oliver'
                ],
                defaultCovers: [
                    'https://images.unsplash.com/photo-1557683316-973673baf926?w=400&q=80',
                    'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80',
                    'https://images.unsplash.com/photo-1497366216548-37526070297c?w=400&q=80',
                    'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&q=80'
                ],

                init() {
                    // Check isolated tab memory
                    const savedSession = sessionStorage.getItem('studyio_current_user');
                    if (savedSession) { 
                        this.currentUser = JSON.parse(savedSession); 
                    }

                    // Pull stored profile edits
                    const savedProfile = localStorage.getItem('studyio_student_profile');
                    if (savedProfile) { 
                        this.profile = JSON.parse(savedProfile); 
                        if (!this.profile.avatarUrl && this.currentUser && this.currentUser.avatar) {
                            this.profile.avatarUrl = this.currentUser.avatar;
                            this.saveProfile();
                        }
                    } else if (this.currentUser) {
                        this.profile.name = this.currentUser.name;
                        if (this.currentUser.avatar) this.profile.avatarUrl = this.currentUser.avatar;
                        this.saveProfile();
                    }

                    // CACHE FIX
                    window.addEventListener('pageshow', (event) => {
                        if (!sessionStorage.getItem('studyio_current_user')) {
                            window.location.href = 'index.html'; 
                        } else {
                            this.currentUser = JSON.parse(sessionStorage.getItem('studyio_current_user'));
                        }
                    });

                    // LOAD INBOX HISTORY FROM MEMORY
                    const savedMessages = localStorage.getItem('studyio_student_inbox_history_' + this.profile.name);
                    if (savedMessages) {
                        this.allMessages = JSON.parse(savedMessages);
                    } else {
                        // Generate a welcome message to show off the UI if inbox is empty
                        const welcomeMsg = {
                            type: 'chat',
                            senderId: 'admin_team',
                            targetContactId: this.mySessionId,
                            senderName: 'Study.io Team',
                            avatarUrl: 'https://ui-avatars.com/api/?name=Study.io&background=b91c1c&color=fff&bold=true',
                            senderProfile: { name: 'Study.io Support', strand: 'Platform Administrators', bio: 'We ensure safe and fast matchmaking!', subjects: ['Platform Support'], hourlyRate: 0 },
                            text: 'Welcome to your dedicated Student Inbox! When you message tutors from the home page, their replies will safely appear right here.'
                        };
                        this.allMessages = [welcomeMsg];
                        localStorage.setItem('studyio_student_inbox_history_' + this.profile.name, JSON.stringify(this.allMessages));
                    }
                    
                    this.rebuildContacts();

                    // CONNECT TO ALL TUTORS IN THE CONTACT LIST
                    this.mqttClient = mqtt.connect('wss://test.mosquitto.org:8081/mqtt');
                    this.mqttClient.on('connect', () => {
                        this.contacts.forEach(c => {
                            this.mqttClient.subscribe('studyio/room/' + c.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase());
                        });
                    });

                    this.mqttClient.on('message', (topic, message) => {
                        const parsedMsg = JSON.parse(message.toString());
                        if (parsedMsg.type === 'chat') {
                            // Save incoming messages to history
                            this.allMessages.push(parsedMsg);
                            localStorage.setItem('studyio_student_inbox_history_' + this.profile.name, JSON.stringify(this.allMessages));
                            
                            this.rebuildContacts();
                            this.scrollToBottom();
                        }
                    });
                },

                async logout() { 
                    this.currentUser = null; 
                    sessionStorage.clear();
                    localStorage.removeItem('sb-vdtokaamdrvyzchtepjy-auth-token'); 
                    try { await supabaseClient.auth.signOut(); } catch(e) {}
                    window.location.href = 'index.html?logged_out=1';
                },

                // *** INBOX LOGIC ***
                rebuildContacts() {
                    const uniqueContacts = {};
                    this.allMessages.forEach(msg => {
                        // Create contact cards for anyone who isn't the student themselves
                        if (msg.senderId !== this.mySessionId && msg.senderProfile) {
                            uniqueContacts[msg.senderId] = {
                                id: msg.senderId,
                                name: msg.senderProfile.name || msg.senderName,
                                avatarUrl: msg.avatarUrl,
                                strand: msg.senderProfile.strand || 'Tutor',
                                bio: msg.senderProfile.bio,
                                subjects: msg.senderProfile.subjects || [],
                                hourlyRate: msg.senderProfile.hourlyRate || 0
                            };
                        }
                    });
                    this.contacts = Object.values(uniqueContacts);
                },

                selectContact(contact) {
                    this.activeContact = contact;
                    this.scrollToBottom();
                },

                get activeChatHistory() {
                    if (!this.activeContact) return [];
                    return this.allMessages.filter(msg => 
                        msg.senderId === this.activeContact.id || 
                        (msg.senderId === this.mySessionId && msg.targetContactId === this.activeContact.id)
                    );
                },

                sendInboxMessage() { 
                    if (this.inboxMessage.trim() === '' || !this.activeContact) return; 
                    
                    const payload = { 
                        type: 'chat', 
                        senderId: this.mySessionId, 
                        targetContactId: this.activeContact.id, // Mark who this is for
                        senderName: this.profile.name, 
                        avatarUrl: this.finalAvatarUrl, 
                        senderProfile: this.profile,
                        text: this.inboxMessage 
                    };

                    // Broadcast to the specific tutor's room
                    const topic = 'studyio/room/' + this.activeContact.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                    this.mqttClient.publish(topic, JSON.stringify(payload)); 
                    
                    // Add it locally to our UI instantly
                    this.allMessages.push(payload);
                    localStorage.setItem('studyio_student_inbox_history_' + this.profile.name, JSON.stringify(this.allMessages));

                    this.inboxMessage = ''; 
                    this.scrollToBottom();
                },

                scrollToBottom() { 
                    setTimeout(() => { 
                        const c = document.getElementById('inbox-messages-container'); 
                        if (c) c.scrollTop = c.scrollHeight; 
                    }, 50); 
                },

                get finalAvatarUrl() {
                    if (this.profile.avatarUrl && this.profile.avatarUrl.trim() !== "") { 
                        return this.profile.avatarUrl; 
                    }
                    if (this.currentUser && this.currentUser.avatar) { 
                        return this.currentUser.avatar; 
                    }
                    return `https://ui-avatars.com/api/?name=${encodeURIComponent(this.profile.name || 'Student')}&background=b91c1c&color=fff&bold=true`;
                },

                get groupedSubjects() {
                    const data = {
                        "Grade 11": { 
                            "Core": [
                                "Physical Education and Health", "General Mathematics", "21st Century Literature", 
                                "Empowerment Technologies", "Entrepreneurship", "Earth Science", 
                                "Earth and Life Science", "Reading and Writing Skills", "Practical Research 1", 
                                "Komunikasyon at Pananaliksik", "Statistics and Probability", "Introduction to the Philosophy of the Human Person"
                            ], 
                            "STEM": ["General Biology 1", "Pre-Calculus", "General Chemistry 1", "General Biology 2", "Basic Calculus"], 
                            "ABM": ["Organization and Management", "Business Math", "Applied Economics", "Principles of Marketing", "Fundamentals of Accountancy, Business, & Math 1"], 
                            "HUMSS": ["Introduction to World Religion and Belief System", "Discipline and Ideas in Social Sciences", "Philippine Politics and Governance", "Creative Writing", "Discipline and Ideas in the Applied Social Sciences"], 
                            "ICT": ["Computer System Servicing 11", "Computer System Servicing (Practical) 11"], 
                            "HE": ["Cookery 11", "Bread and Pastry Production"] 
                        },
                        "Grade 12": { 
                            "Core": [
                                "Personal Development", "Oral Communication in Context", "Understanding Culture, Society, and Politics", 
                                "Pagsulat sa Filipino (Akademik)", "Pagsulat sa Filipino (TekBok)", "Practical Research 2", 
                                "Contemporary Philippine Arts from the Regions", "Physical Education", "English for Academics and Professional Purposes", 
                                "Inquiries, Investigation, and Immersion", "Pagbasa at Pagsusuri sa Iba't Ibang Teksto", "Media Information and Literacy"
                            ], 
                            "STEM": ["General Physics 1", "General Chemistry 2", "Disaster Readiness and Risk Reduction", "General Physics 2", "Capstone"], 
                            "ABM": ["Fundamentals of Accountancy, Business, & Math 2", "Physical Science", "Business Finance", "Business Ethics and Social Responsibility", "Business Enterprise and Simulation"], 
                            "HUMSS": ["Creative Non-Fiction", "Physical Science", "Community, Engagement, Solidarity and Citizenship", "Trends, Networks, and Critical Thinking", "Culminating Activity"], 
                            "ICT": ["Computer Servicing System 12", "Physical Science", "Computer System Servicing 12", "Computer System Servicing (Practical) 12"], 
                            "HE": ["Cookery 12", "Physical Science", "Food and Beverage Services"] 
                        }
                    };
                    let groups = {};
                    for (const grade in data) { 
                        for (const strand in data[grade]) { 
                            groups[`${grade} - ${strand}`] = data[grade][strand]; 
                        } 
                    }
                    return groups;
                },

                saveProfile() {
                    localStorage.setItem('studyio_student_profile', JSON.stringify(this.profile));
                },

                addSubject() { 
                    if (this.selectedSubjectToAdd !== '') { 
                        if (!this.profile.subjects.includes(this.selectedSubjectToAdd)) {
                            this.profile.subjects.push(this.selectedSubjectToAdd); 
                            this.saveProfile(); 
                        }
                        this.selectedSubjectToAdd = ''; 
                    } 
                },
                removeSubject(index) { 
                    this.profile.subjects.splice(index, 1); 
                    this.saveProfile(); 
                }
            }
        }
    </script>
</body>
</html>