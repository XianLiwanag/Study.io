<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study.io | Student Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        oxfordRed: '#b91c1c', 
                        oxfordDark: '#7f1d1d' 
                    },
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'] 
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800" x-data="studentApp()">

    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 sm:h-20 items-center">
            
            <div class="flex items-center gap-2 sm:gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="bg-oxfordRed text-white p-1.5 sm:p-2 rounded-lg">
                    <i class="fa-solid fa-user-graduate text-xl sm:text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg sm:text-2xl font-bold text-oxfordRed leading-tight">Study.io</h1>
                    <p class="text-[9px] sm:text-xs text-gray-500 uppercase tracking-widest leading-tight">Student Portal</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                
                <a href="index.html" class="text-sm text-gray-600 hover:text-oxfordRed transition font-medium flex items-center gap-1.5 p-2 sm:p-0">
                    <i class="fa-solid fa-house text-lg sm:text-sm"></i> 
                    <span class="hidden sm:inline">Home</span>
                </a>
                
                <div class="h-6 sm:h-8 w-px bg-gray-300 mx-1 sm:mx-2 hidden sm:block"></div>
                
                <div class="flex items-center gap-2 text-gray-700 bg-gray-100 px-2 sm:px-3 py-1 sm:py-1.5 rounded-full border border-gray-200 ml-1 sm:ml-2">
                    <img :src="finalAvatarUrl" class="w-6 h-6 sm:w-7 sm:h-7 rounded-full border border-gray-300 object-cover bg-white">
                    <span class="font-semibold text-xs sm:text-sm hidden sm:inline truncate max-w-[100px]" x-text="profile.name"></span>
                </div>

                <button @click="logout()" class="text-sm text-red-600 sm:text-gray-500 hover:text-white sm:hover:text-oxfordRed hover:bg-red-600 sm:hover:bg-red-50 transition font-medium ml-1 sm:ml-2 sm:border border-gray-300 px-2 sm:px-3 py-1.5 rounded-md shadow-sm flex items-center gap-1.5">
                    <i class="fa-solid fa-arrow-right-from-bracket text-lg sm:text-sm"></i> 
                    <span class="hidden sm:inline">Log Out</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 sm:py-12 grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8 min-h-[70vh]">
        
        <div class="lg:col-span-1">
            <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fa-regular fa-address-card text-oxfordRed"></i> My Student Card
            </h3>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 lg:sticky lg:top-24">
                
                <div :class="profile.coverImageUrl ? '' : profile.headerColor" 
                     :style="profile.coverImageUrl ? `background-image: url('${profile.coverImageUrl}'); background-size: cover; background-position: center;` : ''" 
                     class="h-24 sm:h-32 relative transition-all duration-300">
                </div>
                
                <div class="px-5 sm:px-6 pb-5 sm:pb-6 relative">
                    <div class="flex justify-between items-end -mt-10 sm:-mt-12 mb-4">
                        <img :src="finalAvatarUrl" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-white shadow-md bg-white object-cover">
                    </div>
                    
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 leading-tight" x-text="profile.name || 'Student Name'"></h2>
                    
                    <div class="flex flex-wrap items-center text-gray-500 text-[10px] sm:text-xs mt-1.5 sm:mt-2 mb-4 gap-2">
                        <span class="font-medium text-gray-700 bg-gray-100 px-2.5 py-1 rounded-full border border-gray-200">
                            <i class="fa-solid fa-school text-oxfordRed mr-1"></i> <span x-text="profile.strand || 'Not Specified'"></span>
                        </span>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 border-b border-gray-200 pb-1 mb-2 text-xs sm:text-sm">About Me</h3>
                    <p class="text-gray-600 text-xs sm:text-sm leading-relaxed mb-4 whitespace-pre-wrap" x-text="profile.bio || 'Write a little about yourself...'"></p>
                    
                    <div class="bg-red-50 p-3 sm:p-4 rounded-xl border border-red-100 shadow-sm mt-5 sm:mt-6">
                        <h3 class="font-bold text-oxfordRed mb-2 sm:mb-3 text-xs sm:text-sm flex items-center gap-1.5 sm:gap-2">
                            <i class="fa-solid fa-book-open"></i> Subjects I Need Help With
                        </h3>
                        <div class="flex flex-wrap gap-1.5 sm:gap-2">
                            <template x-for="sub in profile.subjects">
                                <span class="text-[10px] sm:text-xs bg-white text-gray-700 px-2.5 py-1 rounded-full border border-gray-200 shadow-sm">
                                    <span x-text="sub"></span>
                                </span>
                            </template>
                            <span x-show="profile.subjects.length === 0" class="text-xs text-gray-400 italic">No subjects added yet.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white p-5 sm:p-8 rounded-xl shadow-sm border border-gray-200">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-5 sm:mb-6 border-b border-gray-100 pb-4 gap-2">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Edit Profile Settings</h2>
                        <p class="text-xs sm:text-sm text-gray-500">Personalize your account. Tutors will see this when you message them!</p>
                    </div>
                    <div class="text-[10px] sm:text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 self-start sm:self-auto inline-flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Auto-Saving
                    </div>
                </div>
                
                <div class="space-y-5 sm:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Full Name</label>
                            <input type="text" x-model="profile.name" @input="saveProfile()" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Grade & Strand</label>
                            <input type="text" x-model="profile.strand" @input="saveProfile()" placeholder="e.g. Grade 11 - STEM" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Default Theme Color</label>
                            <select x-model="profile.headerColor" @change="saveProfile()" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm bg-white text-sm">
                                <option value="bg-gray-800">Slate Dark (Default)</option>
                                <option value="bg-oxfordRed">Oxford Red</option>
                                <option value="bg-blue-600">Ocean Blue</option>
                                <option value="bg-green-600">Forest Green</option>
                                <option value="bg-purple-600">Royal Purple</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 sm:p-5 rounded-xl border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Profile Picture (URL)</label>
                                <input type="text" x-model="profile.avatarUrl" @input="saveProfile()" placeholder="Paste image link here..." class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none text-xs sm:text-sm transition shadow-sm">
                                
                                <div class="mt-3">
                                    <p class="text-[10px] font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Quick Select Avatars</p>
                                    <div class="flex gap-2">
                                        <template x-for="img in defaultAvatars">
                                            <img :src="img" @click="profile.avatarUrl = img; saveProfile()" class="w-8 h-8 rounded-full cursor-pointer hover:ring-2 hover:ring-oxfordRed border border-gray-300 object-cover bg-white transition-transform hover:scale-110">
                                        </template>
                                        <button @click="profile.avatarUrl = ''; saveProfile()" class="w-8 h-8 rounded-full cursor-pointer border border-gray-300 bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors" title="Clear Avatar"><i class="fa-solid fa-eraser text-xs text-gray-500"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Cover Photo (URL)</label>
                                <input type="text" x-model="profile.coverImageUrl" @input="saveProfile()" placeholder="Paste image link here..." class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none text-xs sm:text-sm transition shadow-sm">
                                
                                <div class="mt-3">
                                    <p class="text-[10px] font-semibold text-gray-500 mb-1.5 uppercase tracking-wider">Quick Select Covers</p>
                                    <div class="flex gap-2">
                                        <template x-for="img in defaultCovers">
                                            <div @click="profile.coverImageUrl = img; saveProfile()" class="w-12 h-8 rounded cursor-pointer hover:ring-2 hover:ring-oxfordRed border border-gray-300 bg-cover bg-center transition-transform hover:scale-105" :style="`background-image: url('${img}')`"></div>
                                        </template>
                                        <button @click="profile.coverImageUrl = ''; saveProfile()" class="w-12 h-8 rounded cursor-pointer border border-gray-300 bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors" title="Clear Cover"><i class="fa-solid fa-eraser text-xs text-gray-500"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Short Bio</label>
                        <textarea x-model="profile.bio" @input="saveProfile()" placeholder="Tell tutors a bit about your learning style..." rows="3" class="w-full border border-gray-300 rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm"></textarea>
                    </div>

                    <div class="border-t border-gray-200 pt-5 sm:pt-6">
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">Subjects I Need Help With</label>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4">
                            <select x-model="selectedSubjectToAdd" class="flex-1 border border-gray-300 rounded-md py-2.5 px-3 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm bg-white text-sm">
                                <option value="">-- Select a subject to add --</option>
                                <template x-for="(subjects, category) in groupedSubjects" :key="category">
                                    <optgroup :label="category">
                                        <template x-for="sub in subjects" :key="sub">
                                            <option :value="sub" x-text="sub"></option>
                                        </template>
                                    </optgroup>
                                </template>
                            </select>
                            <button @click="addSubject()" class="bg-gray-800 text-white px-6 sm:px-8 py-2.5 rounded-md font-bold hover:bg-black transition shadow-md text-sm sm:text-base w-full sm:w-auto">Add Subject</button>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(sub, index) in profile.subjects" :key="index">
                                <div class="bg-gray-50 border border-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-xs sm:text-sm flex items-center gap-2 sm:gap-3 shadow-sm">
                                    <span x-text="sub" class="font-medium"></span>
                                    <button @click="removeSubject(index)" class="text-red-400 hover:text-red-600 transition p-1">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Supabase initialized with SessionStorage for Tab Isolation
        const supabaseClient = window.supabase.createClient(
            'https://vdtokaamdrvyzchtepjy.supabase.co', 
            'sb_publishable_1HRmAvVpSXBSpzjOeE5ZeA_Atr3x015',
            { auth: { storage: window.sessionStorage } }
        );

        function studentApp() {
            return {
                currentUser: null,
                profile: {
                    name: "Demo Student", 
                    strand: "Grade 11", 
                    bio: "I am a visual learner looking for help with my core subjects.",
                    headerColor: "bg-gray-800",
                    avatarUrl: "", 
                    coverImageUrl: "",
                    subjects: []
                },
                
                selectedSubjectToAdd: "", 
                
                // *** NEW DEFAULT PRE-MADES ***
                defaultAvatars: [
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Nala',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Oliver'
                ],
                defaultCovers: [
                    'https://images.unsplash.com/photo-1557683316-973673baf926?w=400&q=80',
                    'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80',
                    'https://images.unsplash.com/photo-1497366216548-37526070297c?w=400&q=80',
                    'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&q=80'
                ],

                init() {
                    const savedSession = sessionStorage.getItem('studyio_current_user');
                    if (savedSession) { 
                        this.currentUser = JSON.parse(savedSession); 
                    }

                    // *** GOOGLE SYNC FIX ***
                    // Pull student profile settings. If it has no avatar but the google login gave us one, inject it!
                    const savedProfile = localStorage.getItem('studyio_student_profile');
                    if (savedProfile) { 
                        this.profile = JSON.parse(savedProfile); 
                        if (!this.profile.avatarUrl && this.currentUser && this.currentUser.avatar) {
                            this.profile.avatarUrl = this.currentUser.avatar;
                            this.saveProfile();
                        }
                    } else if (this.currentUser) {
                        this.profile.name = this.currentUser.name;
                        if (this.currentUser.avatar) this.profile.avatarUrl = this.currentUser.avatar;
                        this.saveProfile();
                    }

                    window.addEventListener('pageshow', (event) => {
                        if (!sessionStorage.getItem('studyio_current_user')) {
                            window.location.href = 'index.html'; 
                        } else {
                            this.currentUser = JSON.parse(sessionStorage.getItem('studyio_current_user'));
                        }
                    });
                },

                async logout() { 
                    this.currentUser = null; 
                    sessionStorage.clear();
                    localStorage.removeItem('sb-vdtokaamdrvyzchtepjy-auth-token'); 
                    try { await supabaseClient.auth.signOut(); } catch(e) {}
                    window.location.href = 'index.html?logged_out=1';
                },

                get finalAvatarUrl() {
                    if (this.profile.avatarUrl && this.profile.avatarUrl.trim() !== "") { return this.profile.avatarUrl; }
                    return `https://ui-avatars.com/api/?name=${encodeURIComponent(this.profile.name || 'Student')}&background=random&color=fff&bold=true`;
                },

                get groupedSubjects() {
                    const data = {
                        "Grade 11": { 
                            "Core": [
                                "Physical Education and Health", "General Mathematics", "21st Century Literature", 
                                "Empowerment Technologies", "Entrepreneurship", "Earth Science", 
                                "Earth and Life Science", "Reading and Writing Skills", "Practical Research 1", 
                                "Komunikasyon at Pananaliksik", "Statistics and Probability", "Introduction to the Philosophy of the Human Person"
                            ], 
                            "STEM": ["General Biology 1", "Pre-Calculus", "General Chemistry 1", "General Biology 2", "Basic Calculus"], 
                            "ABM": ["Organization and Management", "Business Math", "Applied Economics", "Principles of Marketing", "Fundamentals of Accountancy, Business, & Math 1"], 
                            "HUMSS": ["Introduction to World Religion and Belief System", "Discipline and Ideas in Social Sciences", "Philippine Politics and Governance", "Creative Writing", "Discipline and Ideas in the Applied Social Sciences"], 
                            "ICT": ["Computer System Servicing 11", "Computer System Servicing (Practical) 11"], 
                            "HE": ["Cookery 11", "Bread and Pastry Production"] 
                        },
                        "Grade 12": { 
                            "Core": [
                                "Personal Development", "Oral Communication in Context", "Understanding Culture, Society, and Politics", 
                                "Pagsulat sa Filipino (Akademik)", "Pagsulat sa Filipino (TekBok)", "Practical Research 2", 
                                "Contemporary Philippine Arts from the Regions", "Physical Education", "English for Academics and Professional Purposes", 
                                "Inquiries, Investigation, and Immersion", "Pagbasa at Pagsusuri sa Iba't Ibang Teksto", "Media Information and Literacy"
                            ], 
                            "STEM": ["General Physics 1", "General Chemistry 2", "Disaster Readiness and Risk Reduction", "General Physics 2", "Capstone"], 
                            "ABM": ["Fundamentals of Accountancy, Business, & Math 2", "Physical Science", "Business Finance", "Business Ethics and Social Responsibility", "Business Enterprise and Simulation"], 
                            "HUMSS": ["Creative Non-Fiction", "Physical Science", "Community, Engagement, Solidarity and Citizenship", "Trends, Networks, and Critical Thinking", "Culminating Activity"], 
                            "ICT": ["Computer Servicing System 12", "Physical Science", "Computer System Servicing 12", "Computer System Servicing (Practical) 12"], 
                            "HE": ["Cookery 12", "Physical Science", "Food and Beverage Services"] 
                        }
                    };
                    let groups = {};
                    for (const grade in data) { 
                        for (const strand in data[grade]) { 
                            groups[`${grade} - ${strand}`] = data[grade][strand]; 
                        } 
                    }
                    return groups;
                },

                saveProfile() {
                    localStorage.setItem('studyio_student_profile', JSON.stringify(this.profile));
                },

                addSubject() { 
                    if (this.selectedSubjectToAdd !== '') { 
                        if (!this.profile.subjects.includes(this.selectedSubjectToAdd)) {
                            this.profile.subjects.push(this.selectedSubjectToAdd); 
                            this.saveProfile(); 
                        }
                        this.selectedSubjectToAdd = ''; 
                    } 
                },
                removeSubject(index) { 
                    this.profile.subjects.splice(index, 1); 
                    this.saveProfile(); 
                }
            }
        }
    </script>
</body>
</html>