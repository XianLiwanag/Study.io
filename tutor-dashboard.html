<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study.io | Tutor Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // PREVENT FLASH OF UNSTYLED CONTENT (Dark Mode)
        if (localStorage.getItem('studyio_theme') === 'dark' || (!('studyio_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        oxfordRed: '#b91c1c', 
                        oxfordDark: '#7f1d1d' 
                    },
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'] 
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .chat-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-100 transition-colors duration-300" x-data="tutorApp()">

    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40 transition-colors duration-300 border-b border-transparent dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 sm:h-20 items-center">
            
            <div class="flex items-center gap-2 sm:gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="bg-oxfordRed text-white p-1.5 sm:p-2 rounded-lg">
                    <i class="fa-solid fa-chalkboard-user text-xl sm:text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg sm:text-2xl font-bold text-oxfordRed leading-tight">Study.io</h1>
                    <p class="text-[9px] sm:text-xs text-gray-500 dark:text-gray-400 uppercase tracking-widest leading-tight" x-text="$store.global.t('dash_tutor_portal')">Tutor Portal</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                <span class="text-[10px] sm:text-xs font-bold px-2 sm:px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400 animate-pulse border border-green-300 dark:border-green-800 hidden md:inline-flex items-center transition-colors">
                    <i class="fa-solid fa-wifi mr-1"></i> <span x-text="$store.global.t('live_sync')">Live Sync Active</span>
                </span>
                
                <div class="h-6 sm:h-8 w-px bg-gray-300 dark:bg-gray-600 mx-1 sm:mx-2 hidden sm:block transition-colors"></div>
                
                <a href="index.html" class="text-sm text-gray-600 dark:text-gray-300 hover:text-oxfordRed dark:hover:text-red-400 transition font-medium flex items-center gap-1.5 p-2 sm:p-0">
                    <i class="fa-solid fa-house text-lg sm:text-sm"></i> 
                    <span class="hidden sm:inline" x-text="$store.global.t('nav_home')">Home</span>
                </a>
                
                <div class="hidden sm:flex items-center gap-2 border-r border-l border-gray-300 dark:border-gray-600 px-3 mx-1 transition-colors">
                    <button @click="$store.global.toggleLang()" class="text-xs font-bold text-gray-600 dark:text-gray-300 hover:text-oxfordRed dark:hover:text-white transition px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                        <span x-text="$store.global.lang === 'en' ? 'EN' : 'TL'"></span>
                    </button>
                    <button @click="$store.global.toggleTheme()" class="text-gray-600 dark:text-gray-300 hover:text-oxfordRed dark:hover:text-yellow-400 transition p-2 rounded-full">
                        <i class="fa-solid" :class="$store.global.theme === 'dark' ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                </div>
                
                <div class="flex items-center gap-2 text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 px-2 sm:px-3 py-1 sm:py-1.5 rounded-full border border-gray-200 dark:border-gray-600 ml-1 sm:ml-2 transition-colors">
                    <img :src="finalAvatarUrl" class="w-6 h-6 sm:w-7 sm:h-7 rounded-full border border-gray-300 dark:border-gray-500 object-cover bg-white">
                    <span class="font-semibold text-xs sm:text-sm hidden sm:inline truncate max-w-[100px]" x-text="profile.name"></span>
                </div>

                <button @click="logout()" class="text-sm text-red-600 sm:text-gray-500 dark:sm:text-gray-400 hover:text-white sm:hover:text-oxfordRed dark:sm:hover:text-red-400 hover:bg-red-600 sm:hover:bg-red-50 dark:sm:hover:bg-gray-700 transition font-medium ml-1 sm:ml-2 sm:border border-gray-300 dark:border-gray-600 px-2 sm:px-3 py-1.5 rounded-md shadow-sm flex items-center gap-1.5">
                    <i class="fa-solid fa-arrow-right-from-bracket text-lg sm:text-sm"></i> 
                    <span class="hidden sm:inline" x-text="$store.global.t('nav_logout')">Log Out</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-16 sm:top-20 z-30 transition-colors">
        <div class="max-w-7xl mx-auto px-4 flex gap-6">
            <button @click="activeTab = 'profile'" :class="activeTab === 'profile' ? 'border-oxfordRed text-oxfordRed dark:text-red-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600'" class="py-4 font-bold text-sm sm:text-base border-b-2 transition flex items-center gap-2">
                <i class="fa-solid fa-user-pen"></i> <span x-text="$store.global.t('dash_profile_tab')">My Profile</span>
            </button>
            <button @click="activeTab = 'inbox'; scrollToBottom();" :class="activeTab === 'inbox' ? 'border-oxfordRed text-oxfordRed dark:text-red-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600'" class="py-4 font-bold text-sm sm:text-base border-b-2 transition flex items-center gap-2 relative">
                <i class="fa-solid fa-inbox"></i> <span x-text="$store.global.t('dash_inbox_tab')">Student Inbox</span>
                <span x-show="contacts.length > 0" class="absolute top-3 -right-3 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-gray-800"></span>
            </button>
        </div>
    </div>

    <main x-cloak x-show="activeTab === 'profile'" class="max-w-7xl mx-auto px-4 py-8 sm:py-12 grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8 min-h-[70vh]">
        
        <div class="lg:col-span-1">
            <h3 class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                <i class="fa-regular fa-eye text-oxfordRed dark:text-red-400"></i> <span x-text="$store.global.t('live_preview')">Live Profile Preview</span>
            </h3>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-100 dark:border-gray-700 lg:sticky lg:top-40 transition-colors">
                <div :class="profile.coverImageUrl ? '' : profile.headerColor" 
                     :style="profile.coverImageUrl ? `background-image: url('${profile.coverImageUrl}'); background-size: cover; background-position: center;` : ''" 
                     class="h-24 sm:h-32 relative transition-all duration-300">
                </div>
                
                <div class="px-5 sm:px-6 pb-5 sm:pb-6 relative">
                    <div class="flex justify-between items-end -mt-10 sm:-mt-12 mb-4">
                        <img :src="finalAvatarUrl" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-white dark:border-gray-800 shadow-md bg-white dark:bg-gray-700 object-cover">
                        <div class="text-right">
                            <span class="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider" x-text="$store.global.t('rate')">Rate</span><br>
                            <span class="font-bold text-oxfordRed dark:text-red-400 text-lg sm:text-xl">₱<span x-text="profile.hourlyRate"></span>/hr</span>
                        </div>
                    </div>
                    
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-white leading-tight" x-text="profile.name || 'Your Name'"></h2>
                    
                    <div class="flex flex-wrap items-center text-gray-500 dark:text-gray-400 text-[10px] sm:text-xs mt-1.5 sm:mt-2 mb-4 gap-2">
                        <span class="font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 px-2.5 py-1 rounded-full border border-gray-200 dark:border-gray-600 transition-colors">
                            <i class="fa-solid fa-id-card text-oxfordRed dark:text-red-400 mr-1"></i> <span x-text="profile.strand || 'Strand'"></span>
                        </span>
                        <span class="bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-400 px-2.5 py-1 rounded-full font-bold border border-green-200 dark:border-green-800 transition-colors">
                            <i class="fa-solid fa-check-circle mr-1"></i> <span x-text="$store.global.t('verified')">Verified</span>
                        </span>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-1 mb-2 text-xs sm:text-sm" x-text="$store.global.t('about_me')">About Me</h3>
                    <p class="text-gray-600 dark:text-gray-300 text-xs sm:text-sm leading-relaxed mb-4 whitespace-pre-wrap" x-text="profile.bio || $store.global.t('bio_placeholder')"></p>
                    
                    <h3 class="font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-1 mb-2 text-xs sm:text-sm" x-text="$store.global.t('expertise')">Expertise</h3>
                    <div class="flex flex-wrap gap-1.5 sm:gap-2 mb-6">
                        <template x-for="sub in profile.subjects">
                            <span class="text-[10px] sm:text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-2.5 py-1 rounded-full border border-gray-200 dark:border-gray-600 shadow-sm transition-colors">
                                <i class="fa-solid fa-check text-oxfordRed dark:text-red-400 mr-1"></i> <span x-text="sub"></span>
                            </span>
                        </template>
                        <span x-show="profile.subjects.length === 0" class="text-xs text-gray-400 dark:text-gray-500 italic" x-text="$store.global.t('no_subjects')">No subjects added.</span>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 sm:p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm transition-colors">
                        <h3 class="font-bold text-gray-800 dark:text-white mb-2 sm:mb-3 text-xs sm:text-sm flex items-center gap-1.5 sm:gap-2">
                            <i class="fa-regular fa-calendar-check text-oxfordRed dark:text-red-400"></i> <span x-text="$store.global.t('availability')">Availability</span>
                        </h3>
                        <ul class="space-y-1.5 sm:space-y-2">
                            <template x-for="slot in profile.schedule">
                                <li class="flex justify-between items-center border-b border-gray-200 dark:border-gray-600 pb-1.5 last:border-0 last:pb-0">
                                    <span class="font-medium text-gray-700 dark:text-gray-300 text-[10px] sm:text-xs" x-text="slot.day"></span>
                                    <span class="text-gray-600 dark:text-gray-200 bg-white dark:bg-gray-800 px-2 py-0.5 sm:px-2.5 sm:py-1 rounded text-[9px] sm:text-[10px] border border-gray-200 dark:border-gray-600 shadow-sm transition-colors" x-text="slot.time"></span>
                                </li>
                            </template>
                            <span x-show="profile.schedule.length === 0" class="text-xs text-gray-400 dark:text-gray-500 italic block mt-1" x-text="$store.global.t('no_schedule')">No schedule added.</span>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 p-5 sm:p-8 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-5 sm:mb-6 border-b border-gray-100 dark:border-gray-700 pb-4 gap-2">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-white" x-text="$store.global.t('edit_profile')">Edit Profile Settings</h2>
                        <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400" x-text="$store.global.t('edit_tutor_desc')">Changes are automatically saved and broadcasted to the main website in real-time.</p>
                    </div>
                    <div class="text-[10px] sm:text-xs font-bold text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 px-2 py-1 rounded border border-green-200 dark:border-green-800 self-start sm:self-auto inline-flex items-center gap-1 transition-colors">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> <span x-text="$store.global.t('auto_saving')">Auto-Saving</span>
                    </div>
                </div>
                
                <div class="space-y-5 sm:space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_name')">Full Name</label>
                            <input type="text" x-model="profile.name" @input="triggerSync()" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_grade')">Grade & Strand</label>
                            <input type="text" x-model="profile.strand" @input="triggerSync()" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_rate')">Hourly Rate (₱)</label>
                            <input type="number" x-model="profile.hourlyRate" @input="triggerSync()" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_theme')">Default Theme Color</label>
                            <select x-model="profile.headerColor" @change="triggerSync()" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                                <option value="bg-oxfordRed">Oxford Red</option>
                                <option value="bg-yellow-600">ABM Gold</option>
                                <option value="bg-teal-700">STEM Teal</option>
                                <option value="bg-indigo-700">HUMSS Indigo</option>
                                <option value="bg-gray-800">Slate Dark</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700 p-4 sm:p-5 rounded-xl border border-gray-200 dark:border-gray-600 transition-colors">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_avatar')">Profile Picture (URL)</label>
                                <input type="text" x-model="profile.avatarUrl" @input="triggerSync()" placeholder="Paste image link here..." class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none text-xs sm:text-sm transition shadow-sm">
                                
                                <div class="mt-3">
                                    <p class="text-[10px] font-semibold text-gray-500 dark:text-gray-400 mb-1.5 uppercase tracking-wider" x-text="$store.global.t('quick_avatars')">Quick Select Avatars</p>
                                    <div class="flex gap-2">
                                        <template x-for="img in defaultAvatars">
                                            <img :src="img" @click="profile.avatarUrl = img; triggerSync()" class="w-8 h-8 rounded-full cursor-pointer hover:ring-2 hover:ring-oxfordRed border border-gray-300 dark:border-gray-500 object-cover bg-white dark:bg-gray-600 transition-transform hover:scale-110">
                                        </template>
                                        <button @click="profile.avatarUrl = ''; triggerSync()" class="w-8 h-8 rounded-full cursor-pointer border border-gray-300 dark:border-gray-500 bg-gray-200 dark:bg-gray-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"><i class="fa-solid fa-eraser text-xs text-gray-500 dark:text-gray-400"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_cover')">Cover Photo (URL)</label>
                                <input type="text" x-model="profile.coverImageUrl" @input="triggerSync()" placeholder="Paste image link here..." class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none text-xs sm:text-sm transition shadow-sm">
                                
                                <div class="mt-3">
                                    <p class="text-[10px] font-semibold text-gray-500 dark:text-gray-400 mb-1.5 uppercase tracking-wider" x-text="$store.global.t('quick_covers')">Quick Select Covers</p>
                                    <div class="flex gap-2">
                                        <template x-for="img in defaultCovers">
                                            <div @click="profile.coverImageUrl = img; triggerSync()" class="w-12 h-8 rounded cursor-pointer hover:ring-2 hover:ring-oxfordRed border border-gray-300 dark:border-gray-500 bg-cover bg-center transition-transform hover:scale-105" :style="`background-image: url('${img}')`"></div>
                                        </template>
                                        <button @click="profile.coverImageUrl = ''; triggerSync()" class="w-12 h-8 rounded cursor-pointer border border-gray-300 dark:border-gray-500 bg-gray-200 dark:bg-gray-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"><i class="fa-solid fa-eraser text-xs text-gray-500 dark:text-gray-400"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1" x-text="$store.global.t('form_tutor_bio')">Teaching Bio</label>
                        <textarea x-model="profile.bio" @input="triggerSync()" rows="4" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2 px-3 sm:py-2.5 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm"></textarea>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700 pt-5 sm:pt-6">
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" x-text="$store.global.t('subjects_teach')">Subjects You Teach</label>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4">
                            <select x-model="selectedSubjectToAdd" class="flex-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2.5 px-3 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm">
                                <option value="" x-text="$store.global.t('select_subject_curriculum')">-- Select a subject from the curriculum to add --</option>
                                <template x-for="(subjects, category) in groupedSubjects" :key="category">
                                    <optgroup :label="category">
                                        <template x-for="sub in subjects" :key="sub">
                                            <option :value="sub" x-text="sub"></option>
                                        </template>
                                    </optgroup>
                                </template>
                            </select>
                            <button @click="addSubject()" class="bg-gray-800 dark:bg-gray-600 text-white px-6 sm:px-8 py-2.5 rounded-md font-bold hover:bg-black dark:hover:bg-gray-500 transition shadow-md text-sm sm:text-base w-full sm:w-auto" x-text="$store.global.t('btn_add_subject')">Add Subject</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(sub, index) in profile.subjects" :key="index">
                                <div class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-3 py-1.5 rounded-md text-xs sm:text-sm flex items-center gap-2 sm:gap-3 shadow-sm transition-colors">
                                    <span x-text="sub" class="font-medium"></span>
                                    <button @click="removeSubject(index)" class="text-red-400 hover:text-red-600 dark:hover:text-red-300 transition p-1"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700 pt-5 sm:pt-6">
                        <label class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" x-text="$store.global.t('avail_schedule')">Availability Schedule</label>
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4">
                            <select x-model="newScheduleDay" class="border border-gray-300 dark:border-gray-600 rounded-md py-2.5 px-3 focus:ring-2 focus:ring-oxfordRed w-full sm:w-1/3 focus:outline-none transition shadow-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-sm">
                                <option value="" x-text="$store.global.t('select_day')">Select Day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                            <input type="text" x-model="newScheduleTime" @keydown.enter.prevent="addSchedule()" placeholder="e.g., 4:00 PM - 6:00 PM" class="flex-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-md py-2.5 px-3 focus:ring-2 focus:ring-oxfordRed focus:outline-none transition shadow-sm text-sm w-full">
                            <button @click="addSchedule()" class="bg-gray-800 dark:bg-gray-600 text-white px-6 sm:px-8 py-2.5 rounded-md font-bold hover:bg-black dark:hover:bg-gray-500 transition shadow-md text-sm sm:text-base w-full sm:w-auto" x-text="$store.global.t('btn_add_slot')">Add Slot</button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(slot, index) in profile.schedule" :key="index">
                                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 p-2.5 sm:p-3 rounded-lg shadow-sm transition-colors">
                                    <div class="flex gap-3 sm:gap-4 items-center">
                                        <span class="font-bold text-gray-800 dark:text-white text-xs sm:text-sm w-20 sm:w-24" x-text="slot.day"></span>
                                        <span class="text-gray-600 dark:text-gray-200 bg-white dark:bg-gray-800 px-2 py-1 sm:px-3 sm:py-1 rounded text-[10px] sm:text-sm border border-gray-200 dark:border-gray-600 shadow-sm transition-colors" x-text="slot.time"></span>
                                    </div>
                                    <button @click="removeSchedule(index)" class="text-red-500 hover:text-white hover:bg-red-500 bg-white dark:bg-gray-800 p-1.5 sm:p-2 rounded-md border border-gray-200 dark:border-gray-600 shadow-sm transition"><i class="fa-solid fa-trash text-xs sm:text-sm"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main x-cloak x-show="activeTab === 'inbox'" class="max-w-7xl mx-auto px-4 py-8 sm:py-12 min-h-[70vh]">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col md:flex-row h-[700px] max-h-[80vh] transition-colors">
            
            <div class="w-full md:w-1/3 border-r border-gray-200 dark:border-gray-700 flex flex-col bg-gray-50 dark:bg-gray-900 flex-shrink-0 h-1/3 md:h-full transition-colors">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm z-10 flex-shrink-0 transition-colors">
                    <h3 class="font-bold text-gray-800 dark:text-white text-lg" x-text="$store.global.t('my_messages')">Messages</h3>
                </div>
                <div class="overflow-y-auto flex-1 chat-scroll p-2 space-y-1">
                    <template x-for="contact in contacts" :key="contact.id">
                        <button @click="selectContact(contact)" :class="activeContact?.id === contact.id ? 'bg-oxfordRed text-white shadow-md' : 'bg-transparent text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700'" class="w-full text-left p-3 rounded-lg transition flex items-center gap-3">
                            <img :src="contact.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(contact.name)}&background=random&color=fff&bold=true`" class="w-10 h-10 rounded-full border-2 border-white dark:border-gray-700 shadow-sm object-cover bg-white dark:bg-gray-800 transition-colors">
                            <div class="overflow-hidden flex-1">
                                <div class="font-bold text-sm truncate" x-text="contact.name"></div>
                                <div :class="activeContact?.id === contact.id ? 'text-red-100' : 'text-gray-500 dark:text-gray-400'" class="text-xs truncate transition-colors">
                                    <span class="uppercase font-bold tracking-wider" x-text="contact.role"></span> • <span x-text="contact.strand"></span>
                                </div>
                            </div>
                        </button>
                    </template>
                    <div x-show="contacts.length === 0" class="text-center p-6 text-gray-400 dark:text-gray-500 text-sm">
                        <i class="fa-solid fa-inbox text-3xl mb-2 text-gray-300 dark:text-gray-600"></i><br><span x-text="$store.global.t('no_messages')">No messages yet.</span>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-2/3 flex flex-col h-2/3 md:h-full bg-white dark:bg-gray-800 relative transition-colors">
                
                <div x-show="!activeContact" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 z-10 bg-white dark:bg-gray-800 transition-colors">
                    <i class="fa-regular fa-comments text-6xl mb-4 text-gray-200 dark:text-gray-700"></i>
                    <p class="text-lg font-medium text-gray-500 dark:text-gray-400" x-text="$store.global.t('select_student_chat')">Select a conversation to start chatting</p>
                </div>

                <template x-if="activeContact">
                    <div class="flex flex-col h-full w-full">
                        <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 shadow-sm flex-shrink-0 transition-colors">
                            <div class="flex items-start gap-4">
                                <img :src="activeContact.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(activeContact.name)}&background=random&color=fff&bold=true`" class="w-14 h-14 rounded-full border border-gray-200 dark:border-gray-600 object-cover shadow-sm bg-white dark:bg-gray-700 transition-colors">
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h2 class="text-lg font-bold text-gray-800 dark:text-white truncate" x-text="activeContact.name"></h2>
                                        <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] font-bold px-2 py-1 rounded border border-gray-200 dark:border-gray-600 uppercase tracking-wide transition-colors" x-text="activeContact.role"></span>
                                    </div>
                                    <p class="text-xs font-semibold text-oxfordRed dark:text-red-400 mb-1" x-text="activeContact.strand"></p>
                                    <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2 italic">"<span x-text="activeContact.bio || 'Needs help studying.'"></span>"</p>
                                </div>
                            </div>
                            <div class="mt-3 flex flex-wrap gap-1.5" x-show="activeContact.subjects && activeContact.subjects.length > 0">
                                <template x-for="sub in activeContact.subjects">
                                    <span class="text-[10px] bg-red-50 dark:bg-red-900/30 text-oxfordRed dark:text-red-300 border border-red-100 dark:border-red-900 px-2 py-0.5 rounded-full transition-colors" x-text="sub"></span>
                                </template>
                            </div>
                        </div>

                        <div id="inbox-messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-900 flex flex-col gap-4 chat-scroll transition-colors">
                            <template x-for="(msg, index) in activeChatHistory" :key="index">
                                <div class="w-full flex flex-col">
                                    
                                    <div x-show="msg.isSystemAlert" class="self-center bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 p-2 rounded-lg text-xs w-[95%] text-center shadow-sm border border-blue-200 dark:border-blue-800 my-1 font-medium transition-colors">
                                        <span x-text="msg.text"></span>
                                    </div>

                                    <div x-show="msg.senderId === mySessionId && !msg.isSystemAlert" class="self-end flex flex-col w-full max-w-[85%] items-end">
                                        <div class="flex gap-2 w-full justify-end">
                                            <div class="bg-oxfordRed text-white p-3 rounded-2xl rounded-tr-none text-sm shadow-sm leading-relaxed" x-text="msg.text"></div>
                                        </div>
                                    </div>
                                    
                                    <div x-show="msg.senderId !== mySessionId && !msg.isSystemAlert" class="self-start flex flex-col w-full max-w-[85%]">
                                        <div class="flex gap-2 w-full">
                                            <img :src="msg.avatarUrl || msg.senderProfile?.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.senderName || 'S')}&background=random&color=fff&bold=true`" class="w-8 h-8 rounded-full border border-gray-200 dark:border-gray-700 object-cover shadow-sm bg-white dark:bg-gray-800 flex-shrink-0 transition-colors">
                                            <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white p-3 rounded-2xl rounded-tl-none text-sm shadow-sm leading-relaxed transition-colors" x-text="msg.text"></div>
                                        </div>
                                    </div>

                                </div>
                            </template>
                        </div>

                        <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex gap-2 flex-shrink-0 transition-colors">
                            <input type="text" x-model="inboxMessage" @keydown.enter="sendInboxMessage()" :placeholder="$store.global.t('msg_placeholder')" class="flex-1 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-full px-5 py-2.5 focus:outline-none focus:ring-2 focus:ring-oxfordRed focus:border-oxfordRed transition shadow-inner">
                            <button @click="sendInboxMessage()" class="bg-oxfordRed text-white w-11 h-11 rounded-full flex justify-center items-center hover:bg-oxfordDark transition shadow-md flex-shrink-0">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('global', {
                theme: localStorage.getItem('studyio_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
                lang: localStorage.getItem('studyio_lang') || 'en',
                
                init() {
                    window.addEventListener('storage', (e) => {
                        if (e.key === 'studyio_theme') {
                            this.theme = e.newValue;
                            if (this.theme === 'dark') {
                                document.documentElement.classList.add('dark');
                            } else {
                                document.documentElement.classList.remove('dark');
                            }
                        }
                        if (e.key === 'studyio_lang') {
                            this.lang = e.newValue;
                        }
                    });
                },

                toggleTheme() {
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('studyio_theme', this.theme);
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                
                toggleLang() {
                    this.lang = this.lang === 'en' ? 'tl' : 'en';
                    localStorage.setItem('studyio_lang', this.lang);
                },
                
                t(key) {
                    const dict = {
                        'en': {
                            'nav_home': 'Home', 
                            'nav_logout': 'Log Out', 
                            'dash_tutor_portal': 'Tutor Portal', 
                            'live_sync': 'Live Sync Active',
                            'dash_profile_tab': 'My Profile', 
                            'dash_inbox_tab': 'Student Inbox',
                            'live_preview': 'Live Profile Preview', 
                            'rate': 'Rate', 
                            'verified': 'Verified', 
                            'about_me': 'About Me', 
                            'bio_placeholder': 'Write your bio here...', 
                            'expertise': 'Expertise', 
                            'no_subjects': 'No subjects added.',
                            'availability': 'Availability', 
                            'no_schedule': 'No schedule added.', 
                            'edit_profile': 'Edit Profile Settings',
                            'edit_tutor_desc': 'Changes are automatically saved and broadcasted to the main website in real-time.',
                            'auto_saving': 'Auto-Saving', 
                            'form_name': 'Full Name', 
                            'form_grade': 'Grade & Strand', 
                            'form_rate': 'Hourly Rate (₱)',
                            'form_theme': 'Default Theme Color', 
                            'form_avatar': 'Profile Picture (URL)', 
                            'form_cover': 'Cover Photo (URL)',
                            'quick_avatars': 'Quick Select Avatars', 
                            'quick_covers': 'Quick Select Covers', 
                            'form_tutor_bio': 'Teaching Bio',
                            'subjects_teach': 'Subjects You Teach', 
                            'select_subject_curriculum': '-- Select a subject from the curriculum to add --',
                            'btn_add_subject': 'Add Subject', 
                            'avail_schedule': 'Availability Schedule', 
                            'select_day': 'Select Day', 
                            'btn_add_slot': 'Add Slot',
                            'my_messages': 'Messages', 
                            'no_messages': 'No messages yet.', 
                            'select_student_chat': 'Select a conversation to start chatting',
                            'msg_placeholder': 'Type your reply...'
                        },
                        'tl': {
                            'nav_home': 'Home', 
                            'nav_logout': 'Mag-log Out', 
                            'dash_tutor_portal': 'Portal ng Tutor', 
                            'live_sync': 'Aktibong Live Sync',
                            'dash_profile_tab': 'Aking Profile', 
                            'dash_inbox_tab': 'Student Inbox',
                            'live_preview': 'Live Profile Preview', 
                            'rate': 'Presyo', 
                            'verified': 'Beripikado', 
                            'about_me': 'Tungkol sa Akin', 
                            'bio_placeholder': 'Isulat ang iyong bio dito...', 
                            'expertise': 'Ekspertise', 
                            'no_subjects': 'Wala pang asignaturang naidagdag.',
                            'availability': 'Availability', 
                            'no_schedule': 'Wala pang iskedyul na naidagdag.', 
                            'edit_profile': 'I-edit ang Profile Settings',
                            'edit_tutor_desc': 'Awtomatikong nase-save at naka-broadcast sa main website in real-time ang iyong mga binago.',
                            'auto_saving': 'Auto-Saving', 
                            'form_name': 'Buong Pangalan', 
                            'form_grade': 'Baitang at Strand', 
                            'form_rate': 'Presyo Kada Oras (₱)',
                            'form_theme': 'Default Theme Color', 
                            'form_avatar': 'Larawan sa Profile (URL)', 
                            'form_cover': 'Cover Photo (URL)',
                            'quick_avatars': 'Mabilisang Pumili ng Avatar', 
                            'quick_covers': 'Mabilisang Pumili ng Cover', 
                            'form_tutor_bio': 'Teaching Bio',
                            'subjects_teach': 'Mga Asignaturang Itinuturo', 
                            'select_subject_curriculum': '-- Pumili ng asignaturang idadagdag --',
                            'btn_add_subject': 'Magdagdag ng Asignatura', 
                            'avail_schedule': 'Iskedyul ng Availability', 
                            'select_day': 'Pumili ng Araw', 
                            'btn_add_slot': 'Idagdag ang Oras',
                            'my_messages': 'Mga Mensahe', 
                            'no_messages': 'Wala pang mensahe.', 
                            'select_student_chat': 'Pumili ng kausap para magsimula ng chat',
                            'msg_placeholder': 'I-type ang iyong sagot...'
                        }
                    };
                    return dict[this.lang]?.[key] || key;
                }
            });
        });

        const tabId = sessionStorage.getItem('studyio_tab_id') || 'tab_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('studyio_tab_id', tabId);

        const supabaseClient = window.supabase.createClient(
            'https://vdtokaamdrvyzchtepjy.supabase.co', 
            'sb_publishable_1HRmAvVpSXBSpzjOeE5ZeA_Atr3x015',
            { auth: { storage: window.sessionStorage, storageKey: 'studyio_auth_' + tabId } }
        );

        function tutorApp() {
            return {
                currentUser: null, 
                activeTab: 'profile', 
                profile: {
                    id: 5, 
                    name: "Cedric Santos", 
                    strand: "Grade 12 - ABM", 
                    bio: "Numbers tell a story. I can help you balance your sheets, understand accounting principles, and excel in Business Math.",
                    hourlyRate: 180, 
                    headerColor: "bg-yellow-600", 
                    avatarUrl: "", 
                    coverImageUrl: "",
                    subjects: [
                        "Fundamentals of Accountancy, Business, & Math 1", 
                        "Fundamentals of Accountancy, Business, & Math 2", 
                        "Business Math"
                    ], 
                    schedule: [
                        { day: "Tuesday", time: "4:00 PM - 6:00 PM" }
                    ]
                },
                
                selectedSubjectToAdd: "", 
                newScheduleDay: "", 
                newScheduleTime: "",
                
                contacts: [],
                activeContact: null,
                allMessages: [], 
                inboxMessage: '',

                mqttClient: null, 
                mySessionId: '', 
                chatTopic: null, 
                syncTimer: null, 

                defaultAvatars: [
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Nala',
                    'https://api.dicebear.com/7.x/avataaars/svg?seed=Oliver'
                ],
                defaultCovers: [
                    'https://images.unsplash.com/photo-1557683316-973673baf926?w=400&q=80',
                    'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&q=80',
                    'https://images.unsplash.com/photo-1497366216548-37526070297c?w=400&q=80',
                    'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&q=80'
                ],

                init() {
                    const savedSession = sessionStorage.getItem('studyio_current_user');
                    if (savedSession) { 
                        this.currentUser = JSON.parse(savedSession); 
                    }

                    if (this.currentUser && this.currentUser.email) {
                        const profileKey = 'studyio_tutor_profile_' + this.currentUser.email;
                        const savedProfile = localStorage.getItem(profileKey);
                        
                        if (savedProfile) { 
                            this.profile = JSON.parse(savedProfile); 
                        } else {
                            this.profile.name = this.currentUser.name;
                            if (this.currentUser.avatar) {
                                this.profile.avatarUrl = this.currentUser.avatar;
                            }
                            this.triggerSync();
                        }
                        
                        this.mySessionId = this.profile.name || this.currentUser.name;
                    }

                    const savedMessages = localStorage.getItem('studyio_tutor_inbox_history_' + this.mySessionId);
                    if (savedMessages) {
                        this.allMessages = JSON.parse(savedMessages);
                        this.rebuildContacts();
                    }

                    window.addEventListener('storage', (e) => {
                        if (e.key === 'studyio_tutor_inbox_history_' + this.mySessionId) {
                            this.allMessages = JSON.parse(e.newValue || '[]');
                            this.rebuildContacts();
                            this.scrollToBottom();
                        }
                    });

                    window.addEventListener('pageshow', (event) => {
                        if (!sessionStorage.getItem('studyio_current_user')) {
                            window.location.href = 'index.html'; 
                        } else {
                            this.currentUser = JSON.parse(sessionStorage.getItem('studyio_current_user'));
                        }
                    });

                    this.chatTopic = 'studyio/room/' + this.mySessionId.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                    this.mqttClient = mqtt.connect('wss://test.mosquitto.org:8081/mqtt');
                    
                    this.mqttClient.on('connect', () => {
                        this.mqttClient.subscribe(this.chatTopic);
                    });

                    this.mqttClient.on('message', (topic, message) => {
                        const parsedMsg = JSON.parse(message.toString());
                        
                        if (parsedMsg.type === 'chat') {
                            
                            // 1. Prevent Echo (My own messages)
                            if (parsedMsg.senderId === this.mySessionId) return;

                            // 2. Prevent Duplicates
                            const isDuplicate = this.allMessages.some(m => m.timestamp === parsedMsg.timestamp && m.senderId === parsedMsg.senderId);
                            if (isDuplicate) return;

                            this.allMessages.push(parsedMsg);
                            localStorage.setItem('studyio_tutor_inbox_history_' + this.mySessionId, JSON.stringify(this.allMessages));
                            
                            this.rebuildContacts();
                            this.allMessages = [...this.allMessages];
                            this.scrollToBottom();
                        }
                    });
                },

                async logout() {
                    this.currentUser = null;
                    sessionStorage.clear();
                    localStorage.removeItem('sb-vdtokaamdrvyzchtepjy-auth-token');
                    try { await supabaseClient.auth.signOut(); } catch(e) {}
                    window.location.href = 'index.html?logged_out=1';
                },

                rebuildContacts() {
                    const uniqueContacts = {};
                    
                    this.allMessages.forEach(msg => {
                        let contactProfile = null;
                        
                        if (msg.senderId === this.mySessionId && msg.targetProfile) {
                            contactProfile = msg.targetProfile;
                        } else if (msg.targetContactId === this.mySessionId && msg.senderProfile) {
                            contactProfile = msg.senderProfile;
                        }

                        if (contactProfile && contactProfile.name) {
                            uniqueContacts[contactProfile.name] = {
                                id: contactProfile.name,
                                name: contactProfile.name,
                                avatarUrl: contactProfile.avatarUrl || msg.avatarUrl || '',
                                strand: contactProfile.strand || 'Student',
                                bio: contactProfile.bio || '',
                                subjects: contactProfile.subjects || [],
                                hourlyRate: contactProfile.hourlyRate || 0,
                                role: contactProfile.role || 'student'
                            };
                        }
                    });
                    
                    this.contacts = Object.values(uniqueContacts);
                },

                selectContact(contact) {
                    this.activeContact = contact;
                    this.scrollToBottom();
                },

                get activeChatHistory() {
                    if (!this.activeContact) return [];
                    
                    return this.allMessages.filter(msg => {
                        return msg.senderId === this.activeContact.name || 
                               msg.targetContactId === this.activeContact.name ||
                               msg.senderProfile?.name === this.activeContact.name ||
                               msg.targetProfile?.name === this.activeContact.name;
                    });
                },

                sendInboxMessage() { 
                    if (this.inboxMessage.trim() === '' || !this.activeContact) return; 
                    
                    let myProfile = { 
                        name: this.profile.name, 
                        strand: this.profile.strand, 
                        bio: this.profile.bio, 
                        subjects: this.profile.subjects, 
                        hourlyRate: this.profile.hourlyRate,
                        role: "tutor" 
                    };

                    const payload = { 
                        type: 'chat', 
                        senderId: this.mySessionId,
                        targetContactId: this.activeContact.name,
                        senderName: this.profile.name, 
                        avatarUrl: this.finalAvatarUrl, 
                        senderProfile: myProfile, 
                        targetProfile: this.activeContact, 
                        text: this.inboxMessage,
                        timestamp: Date.now()
                    };

                    this.mqttClient.publish(this.chatTopic, JSON.stringify(payload)); 
                    
                    let tKey = 'studyio_tutor_inbox_history_' + this.mySessionId;
                    let tHist = JSON.parse(localStorage.getItem(tKey) || '[]');
                    tHist.push(payload);
                    localStorage.setItem(tKey, JSON.stringify(tHist));

                    let sKey = 'studyio_student_inbox_history_' + this.activeContact.name;
                    let sHist = JSON.parse(localStorage.getItem(sKey) || '[]');
                    sHist.push(payload);
                    localStorage.setItem(sKey, JSON.stringify(sHist));

                    this.allMessages = tHist;
                    this.inboxMessage = ''; 
                    this.scrollToBottom();
                },

                scrollToBottom() { 
                    setTimeout(() => { 
                        const c = document.getElementById('inbox-messages-container'); 
                        if (c) c.scrollTop = c.scrollHeight; 
                    }, 50); 
                },

                get finalAvatarUrl() {
                    if (this.profile.avatarUrl && this.profile.avatarUrl.trim() !== "") { 
                        return this.profile.avatarUrl; 
                    }
                    return `https://ui-avatars.com/api/?name=${encodeURIComponent(this.profile.name || 'Tutor')}&background=random&color=fff&bold=true`;
                },

                get groupedSubjects() {
                    const data = {
                        "Grade 11": { 
                            "Core": [
                                "Physical Education and Health", 
                                "General Mathematics", 
                                "21st Century Literature", 
                                "Empowerment Technologies", 
                                "Entrepreneurship", 
                                "Earth Science", 
                                "Earth and Life Science", 
                                "Reading and Writing Skills", 
                                "Practical Research 1", 
                                "Komunikasyon at Pananaliksik", 
                                "Statistics and Probability", 
                                "Introduction to the Philosophy of the Human Person"
                            ], 
                            "STEM": [
                                "General Biology 1", 
                                "Pre-Calculus", 
                                "General Chemistry 1", 
                                "General Biology 2", 
                                "Basic Calculus"
                            ], 
                            "ABM": [
                                "Organization and Management", 
                                "Business Math", 
                                "Applied Economics", 
                                "Principles of Marketing", 
                                "Fundamentals of Accountancy, Business, & Math 1"
                            ], 
                            "HUMSS": [
                                "Introduction to World Religion and Belief System", 
                                "Discipline and Ideas in Social Sciences", 
                                "Philippine Politics and Governance", 
                                "Creative Writing", 
                                "Discipline and Ideas in the Applied Social Sciences"
                            ], 
                            "ICT": [
                                "Computer System Servicing 11", 
                                "Computer System Servicing (Practical) 11"
                            ], 
                            "HE": [
                                "Cookery 11", 
                                "Bread and Pastry Production"
                            ] 
                        },
                        "Grade 12": { 
                            "Core": [
                                "Personal Development", 
                                "Oral Communication in Context", 
                                "Understanding Culture, Society, and Politics", 
                                "Pagsulat sa Filipino (Akademik)", 
                                "Pagsulat sa Filipino (TekBok)", 
                                "Practical Research 2", 
                                "Contemporary Philippine Arts from the Regions", 
                                "Physical Education", 
                                "English for Academics and Professional Purposes", 
                                "Inquiries, Investigation, and Immersion", 
                                "Pagbasa at Pagsusuri sa Iba't Ibang Teksto", 
                                "Media Information and Literacy"
                            ], 
                            "STEM": [
                                "General Physics 1", 
                                "General Chemistry 2", 
                                "Disaster Readiness and Risk Reduction", 
                                "General Physics 2", 
                                "Capstone"
                            ], 
                            "ABM": [
                                "Fundamentals of Accountancy, Business, & Math 2", 
                                "Physical Science", 
                                "Business Finance", 
                                "Business Ethics and Social Responsibility", 
                                "Business Enterprise and Simulation"
                            ], 
                            "HUMSS": [
                                "Creative Non-Fiction", 
                                "Physical Science", 
                                "Community, Engagement, Solidarity and Citizenship", 
                                "Trends, Networks, and Critical Thinking", 
                                "Culminating Activity"
                            ], 
                            "ICT": [
                                "Computer Servicing System 12", 
                                "Physical Science", 
                                "Computer System Servicing 12", 
                                "Computer System Servicing (Practical) 12"
                            ], 
                            "HE": [
                                "Cookery 12", 
                                "Physical Science", 
                                "Food and Beverage Services"
                            ] 
                        }
                    };
                    
                    let groups = {};
                    for (const grade in data) { 
                        for (const strand in data[grade]) { 
                            groups[`${grade} - ${strand}`] = data[grade][strand]; 
                        } 
                    }
                    return groups;
                },

                triggerSync() {
                    if (this.currentUser && this.currentUser.email) {
                        localStorage.setItem('studyio_tutor_profile_' + this.currentUser.email, JSON.stringify(this.profile));
                    }
                    
                    clearTimeout(this.syncTimer);
                    
                    this.syncTimer = setTimeout(() => {
                        const cleanProfileToSync = JSON.parse(JSON.stringify(this.profile));
                        
                        this.mqttClient.publish('studyio/system/profile_updates', JSON.stringify({ 
                            type: 'profile_update', 
                            profile: cleanProfileToSync 
                        }), { retain: true });
                        
                        const newTopic = 'studyio/room/' + this.profile.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                        
                        if (newTopic !== this.chatTopic) {
                            this.mqttClient.unsubscribe(this.chatTopic);
                            this.chatTopic = newTopic;
                            this.mqttClient.subscribe(this.chatTopic);
                        }
                    }, 500);
                },

                addSubject() { 
                    if (this.selectedSubjectToAdd !== '') { 
                        if (!this.profile.subjects.includes(this.selectedSubjectToAdd)) { 
                            this.profile.subjects.push(this.selectedSubjectToAdd); 
                            this.triggerSync(); 
                        } 
                        this.selectedSubjectToAdd = ''; 
                    } 
                },
                
                removeSubject(index) { 
                    this.profile.subjects.splice(index, 1); 
                    this.triggerSync(); 
                },
                
                addSchedule() { 
                    if (this.newScheduleDay !== '' && this.newScheduleTime.trim() !== '') { 
                        this.profile.schedule.push({ 
                            day: this.newScheduleDay, 
                            time: this.newScheduleTime.trim() 
                        }); 
                        this.newScheduleDay = ''; 
                        this.newScheduleTime = ''; 
                        this.triggerSync(); 
                    } 
                },
                
                removeSchedule(index) { 
                    this.profile.schedule.splice(index, 1); 
                    this.triggerSync(); 
                }
            }
        }
    </script>
</body>
</html>